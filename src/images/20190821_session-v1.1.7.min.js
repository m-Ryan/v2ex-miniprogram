!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Session=t()}(this,function(){"use strict";var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])})(e,t)};function t(e,t){function o(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(o.prototype=t.prototype,new o)}var u=function(){return(u=Object.assign||function(e){for(var t,o=1,n=arguments.length;o<n;o++)for(var i in t=arguments[o])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},p=function(){},l=function(e){throw e};function i(t){try{return JSON.parse(t)}catch(e){return t}}function c(t){return Object.getOwnPropertyNames(t).filter(function(e){return void 0!==t[e]}).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])}).join("&")}function d(e){var t=e.split("?")[1];return t?t.split("&").map(function(e){return e.split("=")}).map(function(e){var t,o=e[0],n=e[1];return(t={})[decodeURIComponent(o)]=i(decodeURIComponent(n)),t}).reduce(function(e,t){return u({},e,t)},{}):{}}function h(e){return i(e&&e.responseText)}var f=function(o){function e(e){var t=o.call(this,"[Request] Request error with status "+e.status)||this;return t.status=e.status,t.body=h(e),t}return t(e,o),e}(Error),w=function(e,t,o){void 0===t&&(t=p),void 0===o&&(o=l);var n,i=e.xhr?e.xhr():new XMLHttpRequest,a=e.url;if(e.query){var r=u({},d(e.url),e.query);a=e.url.replace(/\?.*$/,"")+"?"+c(r)}if(e.withCredentials&&(i.withCredentials=!0),i.onreadystatechange=function(){4===i.readyState&&(200<=i.status&&i.status<300?t(h(i)):o(new f(i)),w.stop&&w.stop(i,e),e.stop&&e.stop(i))},i.open(e.method,e.baseUrl?e.baseUrl+a:a,!0),e.headers){var s=e.headers;Object.getOwnPropertyNames(e.headers).forEach(function(e){return i.setRequestHeader(e,s[e])})}"POST"===e.method&&(n="json"===e.dataType?(i.setRequestHeader("Content-Type","application/json"),JSON.stringify(e.data)):"form"===e.dataType?(i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c(e.data)):e.data),w.start&&w.start(i,e),e.start&&e.start(i),i.send(n)},o={NODE_ENV:"production",API_BASE_URL:"https://m.lizhiweike.com",SESSION_BASE_URL:"https://open.lizhiweike.com",LOGIN_URL:"/account2/login/",GET_TOKEN_URL:"/account2/api/get_access_token",LOGOUT_URL:"/account2/login/clear",REFRESH_TIMEOUT:36e5,JSSDK_CONFIG_API:"/api/weixin/jssdk_config",WX_APP_ID:"wx3502aeb0c3639966"};"dbg.weike.fm"!==location.hostname&&"dbg.lizhiweike.com"!==location.hostname&&"localhost"!==location.hostname||(o.API_BASE_URL="http://dbg.lizhiweike.com",o.SESSION_BASE_URL="http://dev.open.lizhiweike.com");var e=function(){function e(){this.GlobalVariable=o,this.initVariable()}return e.prototype.initVariable=function(){var e=u({},window.SessionGlobalVariable);this.GlobalVariable=u({},o,e)},e}(),a=function(e,t){if("string"!=typeof e)throw new TypeError("argument str must be a string");for(var o={},n=t||{},i=e.split(y),a=n.decode||m,r=0;r<i.length;r++){var s=i[r],c=s.indexOf("=");if(!(c<0)){var u=s.substr(0,c).trim(),p=s.substr(++c,s.length).trim();'"'==p[0]&&(p=p.slice(1,-1)),null==o[u]&&(o[u]=S(p,a))}}return o},m=decodeURIComponent,y=/; */;function S(t,e){try{return e(t)}catch(e){return t}}var r=(new e).GlobalVariable,s="SSR_TOKEN";/share\.lizhiweike\.com/.test(location.href)?window.clientId=window.clientId||"weike-html5-share":/m\.weike\.fm/.test(location.href)&&(window.clientId=window.clientId||"weike-frontend2");var _=window.clientId||"weike-html5-frontend",g={baseURL:r.SESSION_BASE_URL,clientId:_},v=function(o){function e(e){var t=o.call(this,e instanceof f?"[Session] Error with status "+e.status:"[Session] Error with code "+e.code)||this;return t.data=e,t}return t(e,o),e}(Error),A=function(){function e(){this.fetchPromises=[],this.inFetch=!1,this.sessionData=null}return e.prototype.getToken=function(t,o){var n=this;void 0===t&&(t=p),void 0===o&&(o=l),window.IS_SERVER_SIDE_RENDER&&(this.sessionData=this.getCookieAccount(),this.sessionData)?t(u({},this.sessionData)):this.sessionData&&!this.isTokenExpired()?t(u({},this.sessionData)):this.fetchToken(function(e){n.sessionData=e,t(u({},n.sessionData)),n.storeToken()},function(e){if(e.data instanceof f&&401===e.data.status||!(e.data instanceof f)&&0!==e.data.code)n.login();else{if(o===p)throw e;o(e)}})},e.prototype.login=function(e){this.clear();var t=g.baseURL+"/oauth2/authorize",o="?client_id="+_+"&response_type=cookie&redirect_uri="+encodeURIComponent(e||location.href);location.assign(""+t+o)},e.prototype.logout=function(e){this.clear();var t=g.baseURL+"/oauth2/clear",o="?client_id="+_+"&redirect_uri="+encodeURIComponent(e||location.href);location.assign(""+t+o)},e.prototype.clear=function(){this.clearTokenStore(),this.sessionData=null},e.prototype.promisesAllSuccess=function(o){this.fetchPromises.forEach(function(e){var t=e.onSuccess;return t?t(o):void 0}),this.fetchPromises=[],this.inFetch=!1},e.prototype.promisesAllFailed=function(o){this.fetchPromises.forEach(function(e){var t=e.onFailed;return t?t(o):void 0}),this.fetchPromises=[],this.inFetch=!1},e.prototype.isTokenExpired=function(){return!this.sessionData||Date.now()>this.sessionData.expiredAt},e.prototype.getCookieAccount=function(){var e=a(document.cookie);if(e)try{return JSON.parse(e[s])}catch(e){}return null},e.prototype.storeToken=function(){if(this.sessionData){var e=this.sessionData,t=e.token,o=e.expiredAt,n=e.id;localStorage.setItem("Session/token",t),localStorage.setItem("Session/expiredAt",o.toString()),localStorage.setItem("Session/id",n.toString()),document.cookie=s+"= "+JSON.stringify({token:t,expiredAt:o,id:n})}},e.prototype.loadToken=function(){var e=localStorage.getItem("Session/token"),t=localStorage.getItem("Session/expiredAt"),o=t?parseInt(t,10)||0:null,n=localStorage.getItem("Session/id"),i=n?parseInt(n,10)||0:null;return e&&o&&i?this.sessionData={token:e,expiredAt:o,id:i}:(this.clearTokenStore(),null)},e.prototype.clearTokenStore=function(){Object.getOwnPropertyNames(localStorage).forEach(function(e){return/^Session\//.test(e)?localStorage.removeItem(e):void 0}),document.cookie=""},e.prototype.fetchToken=function(e,t){var a=this;void 0===e&&(e=p),void 0===t&&(t=l);var o=g.baseURL,n="/oauth2/access_token?client_id="+g.clientId+"&grant_type=cookie";this.fetchPromises.push({onSuccess:e,onFailed:t}),this.inFetch||(this.inFetch=!0,w({baseUrl:o,url:n,method:"GET",withCredentials:!0},function(e){var t=e.code,o=e.access_token,n=e.account;if(0===t){var i={account:n,token:o,expiredAt:Date.now()+r.REFRESH_TIMEOUT,id:n.id};a.promisesAllSuccess(i),localStorage.lzwk_id=i.id}else a.promisesAllFailed(new v(e))},function(e){return a.promisesAllFailed(new v(e))}))},e}(),I=["onMenuShareTimeline","onMenuShareAppMessage","updateAppMessageShareData","updateTimelineShareData","onMenuShareQQ","onMenuShareWeibo","onMenuShareQZone","stopRecord","startRecord","onVoiceRecordEnd","playVoice","pauseVoice","stopVoice","onVoicePlayEnd","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","downloadImage","translateVoice","getNetworkType","openLocation","getLocation","hideOptionMenu","showOptionMenu","hideMenuItems","showMenuItems","hideAllNonBaseMenuItem","showAllNonBaseMenuItem","closeWindow","scanQRCode","chooseWXPay","openProductSpecificView","addCard","chooseCard","openCard","launch3rdApp"],k=window.wx,E={ready:!1};k&&k.ready(function(){return E.ready=!0});var b=(new e).GlobalVariable,P={WX_APP_ID:b.WX_APP_ID,API_BASE_URL:b.API_BASE_URL,JSSDK_CONFIG_API:b.JSSDK_CONFIG_API},R=function(){function c(e,t){this.wxConfig=null,this.wx=e,this.session=t,this.initJSSDK()}return c.getDefaultShareData=function(){return{title:"荔枝微课，拥有PPT语音同步、视频语音交互，一分钟创建课程。与三千万伙伴一同享受成长的快乐。只有一种稳赚不赔的投资，就是学习",desc:"荔枝微课，拥有PPT语音同步、视频语音交互，一分钟创建课程。与三千万伙伴一同享受成长的快乐。只有一种稳赚不赔的投资，就是学习",imgUrl:"https://static-1253442168.image.myqcloud.com/picture/8173011_2c2209ae7abd04b1a62a65d75ce54a2f.jpg-picmsg420",link:location.href}},c.prototype.wxShare=function(a,r){var s=this;this.wx.ready(function(){var e,t,o=c.getDefaultShareData();t=Array.isArray(a)?(e=a[0],a[1]):e=a;var n=function(){r&&r("appMessage")},i=function(){r&&r("timeline")};s.wx.updateAppMessageShareData?(s.wx.updateAppMessageShareData(u({},o,e,{success:n})),s.wx.updateTimelineShareData(u({},o,t,{success:i}))):(s.wx.onMenuShareAppMessage(u({},o,e,{success:n})),s.wx.onMenuShareTimeline(u({},o,t,{success:i})))})},c.prototype.initJSSDK=function(o){var n=this;void 0===o&&(o=P.WX_APP_ID),this.session.getToken(function(e){var t=e.token;w({method:"GET",baseUrl:P.API_BASE_URL,url:P.JSSDK_CONFIG_API,query:{url:location.href,appid:P.WX_APP_ID,token:t}},function(e){n.wxConfig=e,n.wxConfig.appId=o,n.wxConfig.timestamp=e.data.timestamp,n.wxConfig.nonceStr=e.data.nonceStr,n.wxConfig.signature=e.data.signature,n.wxConfig.jsApiList=I,n.wxConfig.debug="production"!==b.NODE_ENV,n.wx.config(n.wxConfig)})})},c}(),x=navigator.userAgent.toLocaleLowerCase();var T,U,O=(U=null,[[/windowswechat/,T="pc"],[/micromessenger/,"weixin"],[/alipay|weibo|qq\//,"alipy"]].forEach(function(e){var t=e[0],o=e[1];!U&&t.test(x)&&(U=o)}),U||T),D={API_BASE_URL:(new e).GlobalVariable.API_BASE_URL},C=function(){function e(e,t){this.session=e,this.weixinApi=t}return e.prototype.pay=function(o,n,i,a){var r=this;void 0===n&&(n=p),void 0===i&&(i=l),void 0===a&&(a=p);var s=d(location.href),c=this.weixinApi;"alipy"===O?this.getAlipay(o,s,function(e){return n({type:"alipay",payUrl:e.data.params.pay_url,data:e})},i):"weixin"===O&&c&&E.ready?this.getWxpay(o,s,function(e){var t=function(){"pay_channel"===o.product&&s.platform&&s.user_sign&&r.bindOuterAccount(e.invoice_id,s.platform,s.user_sign),n({type:"wxpay",invoiceId:e.invoice_id,data:e})};0===o.fee?t():c.wx.chooseWXPay(u({},e.params,{success:t,fail:i,cancel:a}))},i):this.getWxpay(o,s,function(t){0===o.fee?n({type:"qrcode",codeUrl:"",data:t}):r.getNativeRepay(t.invoice_id,function(e){s.platform&&s.user_sign&&r.bindOuterAccount(t.invoice_id,s.platform,s.user_sign),n({type:"qrcode",codeUrl:e.data.code_url,data:t})},i)},i)},e.prototype.getWxpay=function(o,n,i,a){this.session.getToken(function(e){var t=e.token;return w({method:"GET",baseUrl:D.API_BASE_URL,url:"/api/pay/wxpay",query:u({},n,o,{token:t})},function(e){return 0===e.code?i(e):a(e)},a)},a)},e.prototype.getAlipay=function(o,n,i,a){this.session.getToken(function(e){var t=e.token;return w({method:"GET",baseUrl:D.API_BASE_URL,url:"/api/pay/alipay",query:u({},n,o,{token:t})},function(e){return 0===e.code?i(e):a(e)},a)},a)},e.prototype.getNativeRepay=function(o,n,i){this.session.getToken(function(e){var t=e.token;return w({method:"POST",baseUrl:D.API_BASE_URL,url:"/api/pay/native_repay",query:{token:t},dataType:"form",data:{invoice_id:o}},function(e){return 0===e.code?n(e):i(e)},i)},i)},e.prototype.bindOuterAccount=function(o,n,i){this.session.getToken(function(e){var t=e.token;w({baseUrl:D.API_BASE_URL,url:"/api/invoice/"+o+"/bind_outer_account",query:{token:t},method:"POST",dataType:"form",data:{platform:n,user_sign:i}})})},e}(),L=new A,N=k?new R(k,L):void 0,M=new C(L,N),V=L;return V.payPlatform=O,V.weixinApi=N,V.payManager=M,V});
//# sourceMappingURL=session-v1.1.7.min.js.map
